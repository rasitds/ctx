# Journal Site Rendering Fixes

## Status: IN PROGRESS

Code changes are in `internal/cli/journal/normalize.go` and
`internal/cli/journal/journal_test.go`. Tests pass. Binary needs
rebuild + `ctx journal site` to verify visually.

## Context

Session 2026-02-20 debugged multiple rendering issues in the journal
site pipeline. The site copy is generated by `normalizeContent()` in
`normalize.go`, which runs after source normalization.

## Pipeline Recap

**Source normalization** (written back to journal file):
`stripSystemReminders` -> `cleanToolOutputJSON` -> `consolidateToolRuns`
-> `mergeConsecutiveTurns` -> `softWrapContent` -> `collapseToolOutputs`

**Site copy** (read-only, for rendering):
`injectSourceLink` -> `injectSummary` -> `normalizeContent(content, fencesVerified)`

## Bugs Found and Fixed (this session)

### 1. `<details>/<pre>` wrappers passing through when fencesVerified=true

**Root cause**: `wrapToolOutputs` was gated by `if !fencesVerified` — skipped
entirely for verified files. But the source still has `<details><pre>` wrappers
from the old export format and from `collapseToolOutputs`. These pass through
to the site copy and break CommonMark rendering (Type 6 HTML block `<details>`
ends at blank line, orphaning the `<pre>`).

**Fix**: Always run `wrapToolOutputs`. Added `isAlreadyFenced()` to detect
tool output that's already in a fenced code block (from the AI normalize
skill) and skip re-wrapping.

### 2. `stripPreWrapper` incorrectly unescaping non-`<pre>` content

**Root cause**: HTML entity unescaping triggered on any wrapper tag
(`<details>`, `<summary>`), but only the old `<pre>` format HTML-escapes
content. `collapseToolOutputs` uses `<details>/<summary>` without `<pre>`
and does NOT HTML-escape.

**Fix**: Only unescape when `<pre>` tags are specifically found (`hadPre`
flag), not just when any wrapper is stripped.

### 3. Inner fence markers causing nesting conflicts

**Root cause**: Tool output content (e.g., reading another journal file)
contains ``` fence markers. Wrapping in ``` creates nesting where inner
fences pair with the outer fence.

**Fix**: `fenceForContent()` scans content for the longest fence marker and
returns one backtick longer (e.g., ```` if content has ```).

### 4. Fence tracking only recognized 3-backtick fences

**Root cause**: `normalizeContent`'s line-by-line transforms used
`strings.TrimSpace(line) == codeFence` (exactly ```). When `fenceForContent`
used 4+ backticks, the fence tracking didn't recognize them, so heading
demotion and other transforms ran inside fenced blocks.

**Fix**: Replaced with CommonMark-compliant fence tracking using
`config.RegExFenceLine`. Tracks opening fence character and length; closing
fence must use same char, >= length, no info string.

### 5. Embedded turn headers from other files breaking boundary detection

**Root cause**: Tool output that reads another journal file contains that
file's turn headers (e.g., `### 802. Assistant (15:04:53)` inside turn 41's
body). The old boundary detection (`nextNum > turnNum && nextTime >= turnTime`)
treated these as real boundaries. The real next turn `### 42. Assistant` was
then swallowed (42 < 802).

**Fix**: Pre-scan all turn numbers in the document, sort and deduplicate.
For turn N, the boundary target is `min(turnNums > N)` — the smallest turn
number greater than N. Uses **last-match-wins**: if the same turn number
appears multiple times (embedded + real), the last positional occurrence is
the real one (it comes after the `</details>` closing tags).

Functions: `collectTurnNumbers()`, `nextInSequence()`.

### 6. Context compaction `<summary>` tags (from previous session, in reduce.go)

**Root cause**: Claude Code's context compaction injects multi-line
`<summary>...</summary>` blocks that markdown renderers interpret as HTML.

**Fix**: `stripSystemReminders` now also strips standalone `<summary>` blocks
(multi-line) and compaction boilerplate. Safe disambiguation: Claude Code's
`<summary>` is always standalone on its own line; ours is always single-line
(`<summary>N lines</summary>`). Documented as invariant in godoc.

## Remaining Bug: Stray User Fences

### Problem

File: `2026-02-19-can-you-check-out-https-github-com-activememory-b58ae617-p4.md`

User turn 622 has terminal UI output with a stray/unclosed ``` at source
line 285. With `fencesVerified=true`, this fence marker is preserved in
the site copy. It opens a code block that is never closed, swallowing
ALL subsequent turns (623+) into a preformatted block.

### Decided Approach: Strip fences from User turns

**Rationale**: Code fences in user messages are decorative — they were for
the Claude Code chat UI. The site should display user input as preformatted
text, so fences serve no structural purpose and actively cause problems.

**Implementation plan**:

1. Add a new pass (before line-by-line transforms) that identifies User turn
   bodies and strips all fence markers from them.
2. Wrap User turn bodies in `<pre><code>...</code></pre>` with HTML-escaped
   content. This is more robust than fenced code blocks because:
   - Type 1 HTML block — survives blank lines (ends at `</pre>`, not blank line)
   - HTML escaping prevents ALL inner content conflicts
   - No fence depth calculation or tracking needed
   - `</pre>` in content becomes `&lt;/pre&gt;` after escaping — safe
3. Use the existing boundary detection (pre-scan + last-match-wins) to find
   User turn body boundaries.

**Format comparison**:

| Format                  | Blank lines | Inner conflicts         | Escaping needed |
|-------------------------|-------------|-------------------------|-----------------|
| ``` fenced blocks       | OK          | Inner ``` need deeper   | No              |
| `<pre><code>`  (Type 1) | OK          | None after HTML-escape  | Yes             |
| `<details><pre>` (old)  | BROKEN      | Type 6 ends at blank    | Yes             |

**Trade-off**: User messages with markdown formatting (bold, links, lists)
are flattened to plain text. This is acceptable — preserving user input
verbatim is more valuable than rendering decorative formatting.

### TODO

- [ ] Implement `wrapUserTurns()` function that:
  - Finds `### N. User (HH:MM:SS)` headers
  - Collects body until next turn (same boundary detection as wrapToolOutputs)
  - Strips fence markers from body
  - HTML-escapes content
  - Wraps in `<pre><code>...</code></pre>`
- [ ] Add tests for stray fence, normal user content, user content with HTML
- [ ] Consider whether tool output should also use `<pre><code>` instead of
      fenced code blocks (simpler, eliminates fence depth calculation)
- [ ] Rebuild binary and regenerate site to verify all fixes
- [ ] Visually inspect problem files:
  - `2026-02-20-caveat-the-messages-below-were-generated-by-the-0ddbaa82.md`
  - `2026-02-19-can-you-check-out-https-github-com-activememory-b58ae617-p4.md`
  - `2026-02-20-we-are-debugging-the-new-journal-enrichment-and-047272e0-p2.md`

## Files Changed

- `internal/cli/journal/normalize.go` — All fixes above (except #6)
- `internal/cli/journal/reduce.go` — Fix #6 (compaction summary stripping)
- `internal/cli/journal/journal_test.go` — New test cases
- `internal/config/marker.go` — Compaction constants
- `internal/config/tpl_recall.go` — Invariant documentation

## Learnings Persisted

1. "Tool output boundary detection: pre-scan + last-match-wins"
2. "Journal site normalizeContent: three-layer tool output fix"
