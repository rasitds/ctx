# Journal Normalize Pipeline

Specification for the `normalizeContent` pipeline that sanitizes exported
session transcripts for static site rendering via zensical (Python-Markdown).

## Pipeline Order

```
normalizeContent(content, fencesVerified)
  1. stripFences(content)        â€” remove all ``` / ~~~ fence lines
  2. wrapToolOutputs(content)    â€” wrap Tool Output sections in fenced code blocks
  3. Line-by-line pass (skip lines inside fenced code blocks):
     a. Skip YAML frontmatter (--- delimited)
     b. Sanitize H1: strip Claude tags, truncate to 75 chars
     c. Demote non-turn-header headings to bold (## Foo â†’ **Foo**)
     d. Insert blank line before list items when previous line is non-empty
     e. Strip bold from tool-use lines (** â†’ ðŸ”§)
     f. Escape glob stars outside indented lines
     g. Replace inline code spans with angle brackets (` â†’ ", < â†’ &lt;)
```

## Key Constraint: Python-Markdown

Zensical uses Python-Markdown (via mkdocs), NOT CommonMark.

**Critical difference**: Python-Markdown ends ALL HTML blocks at blank lines.
CommonMark has Type 1 blocks (`<pre>`) that only end at the closing tag, but
Python-Markdown does not implement this. This means:

- `<pre><code>` does NOT protect content from markdown parsing
- `<details><pre>` is even worse (Type 6, also ends at blank lines)
- Blank lines in tool output content break any HTML-based wrapping

**Solution**: Fenced code blocks (```) correctly survive blank lines and
prevent all markdown/HTML interpretation. Safe because `stripFences` runs
first, removing all fence lines from content.

## Tool Output Wrapping

### Boundary Detection

A Tool Output section is bounded by:
- **Start**: Turn header matching `### N. Tool Output (HH:MM:SS)`
- **End**: Next turn header `### M. Role (HH:MM:SS)` where M > N
  and timestamp >= tool output's timestamp

The sequential number + timestamp check prevents false matches from tool
output content that happens to contain turn-header-like text, while
tolerating gaps in turn numbering (e.g., 348 â†’ 350).

### Wrapping

1. Collect body lines between Tool Output header and next turn header
2. `stripPreWrapper`: strip any existing `<details>/<summary>/<pre>` from
   export pipeline; unescape HTML entities if wrappers were present
3. Emit fenced code block: ``` + raw content + ```

Content is emitted verbatim â€” no `html.EscapeString`, no markdown escaping.

### Tool Output Styling

CSS in `docs/stylesheets/extra.css` (generated by `run.go`):

```css
.md-typeset pre {
  font-size: 1.1em;
}

[data-md-color-scheme="default"] .md-typeset pre code {
  color: #1a1a1a;
}

[data-md-color-scheme="slate"] .md-typeset pre code {
  color: #AECB32;
  background-color: #1D1F21;
}
```

`extra_css` in `zensical.toml` must appear under `[project]`, after the
`nav` array and before `[project.theme]`.

## Title Sanitization

Applied at multiple points in the pipeline:

| Location | What | When |
|---|---|---|
| `recall/slug.go` cleanTitle | Strip Claude tags, normalize whitespace, truncate 75 chars | Export to .context/journal/ |
| `journal/parse.go` parseJournalEntry | Strip Claude tags, replace `<>` with entities, strip backtick/#, trim | Site generation (index, nav) |
| `journal/normalize.go` normalizeContent | Strip Claude tags from H1, truncate 75 chars | Site generation (entry pages) |

### Characters Handled

| Character | In link text (parse.go) | In H1 (normalize.go) | In inline code (normalize.go) |
|---|---|---|---|
| `<` `>` | â†’ `&lt;` `&gt;` | Left to fence wrapping | â†’ `&lt;` `&gt;` + backtickâ†’quote |
| `` ` `` | Stripped | N/A | Replaced with `"` |
| `#` | Stripped | N/A | N/A |
| Claude tags | Stripped via regex | Stripped via regex | N/A |

### Length

`config.RecallMaxTitleLen = 75` â€” truncates on word boundary (last space
before limit). Applied in `cleanTitle` and `normalizeContent` H1 pass.

## Shared Regex

`config.RegExClaudeTag` matches `</?(?:command-message|command-name|local-command-caveat)>`.
Lives in `config/regex.go` (not journal package) because it's used by both
`journal/parse.go` and `recall/slug.go`.

## Files Modified (This Session)

- `internal/config/regex.go` â€” `RegExClaudeTag`, `RegExInlineCodeAngle`
- `internal/config/limit.go` â€” `RecallMaxTitleLen = 75`
- `internal/config/tpl_journal.go` â€” `TplZensicalExtraCSS`, `JournalExtraCSS`
- `internal/cli/journal/normalize.go` â€” `wrapToolOutputs`, `stripPreWrapper`, inline code handling, H1 sanitization
- `internal/cli/journal/parse.go` â€” title sanitization (entities, backtick/hash strip)
- `internal/cli/journal/generate.go` â€” `extra_css` TOML emission
- `internal/cli/journal/run.go` â€” write `docs/stylesheets/extra.css`
- `internal/cli/recall/slug.go` â€” `cleanTitle` Claude tag strip + 75-char truncation
